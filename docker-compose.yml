networks:
  backend:
    name: backend

x-env-aspnet: &env-aspnet
  ZuneNetContext__ConnectionString: ${ZuneNetContext__ConnectionString}
  ZuneNetContext__DatabaseName: ${ZuneNetContext__DatabaseName}

services:
  mongodb:
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - 27017:27017
    volumes:
      - mongodb_data_container:/data/db
    networks:
      - backend

  traefik:
    image: traefik:v3.3
    command:
      - "--tracing=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entryPoints.web.address=:80"
      - "--entryPoints.websecure.address=:443"
      - "--certificatesresolvers.leresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.leresolver.acme.email=${SSL_ACME_EMAIL}"
      - "--certificatesresolvers.leresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "./letsencrypt:/letsencrypt"
    networks:
      - backend

  catalog:
    build:
      context: ./
      dockerfile: Zune.Net.Catalog/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8070:8080"
    labels:
      - "traefik.http.routers.catalog.rule=HostRegexp(`^catalog\\..+`)"
      - "traefik.http.routers.catalog-ssl.rule=HostRegexp(`^catalog(-ssl)?\\..+`)"
      - "traefik.http.routers.catalog-ssl.entrypoints=websecure"
      - "traefik.http.routers.catalog-ssl.tls.certresolver=leresolver"
    environment:
      << : [*env-aspnet]

  catalog-image:
    build:
      context: ./
      dockerfile: Zune.Net.Catalog.Image/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8071:8080"
    labels:
      - "traefik.http.routers.catalog-image.rule=HostRegexp(`^image\\.catalog\\..+`)"
      - "traefik.http.routers.catalog-image-ssl.rule=HostRegexp(`^image\\.catalog\\..+`)"
      - "traefik.http.routers.catalog-image-ssl.entrypoints=websecure"
      - "traefik.http.routers.catalog-image-ssl.tls.certresolver=leresolver"
    environment:
      << : [*env-aspnet]

  commerce:
    build:
      context: ./
      dockerfile: Zune.Net.Commerce/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8072:8080"
    labels:
      - "traefik.http.routers.commerce.rule=HostRegexp(`^commerce\\..+`)"
      - "traefik.http.routers.commerce-ssl.rule=HostRegexp(`^commerce(-ssl)?\\..+`)"
      - "traefik.http.routers.commerce-ssl.entrypoints=websecure"
      - "traefik.http.routers.commerce-ssl.tls.certresolver=leresolver"
    environment:
      << : [*env-aspnet]

  inbox:
    build:
      context: ./
      dockerfile: Zune.Net.Inbox/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8073:8080"
    labels:
      - "traefik.http.routers.inbox.rule=HostRegexp(`^inbox\\..+`)"
      - "traefik.http.routers.inbox-ssl.rule=HostRegexp(`^inbox(-ssl)?\\..+`)"
      - "traefik.http.routers.inbox-ssl.entrypoints=websecure"
      - "traefik.http.routers.inbox-ssl.tls.certresolver=leresolver"
    environment:
      << : [*env-aspnet]

  login:
    build:
      context: ./
      dockerfile: Zune.Net.Login/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8074:8080"
    labels:
      - "traefik.http.routers.login.rule=HostRegexp(`^login\\..+`)"
      - "traefik.http.routers.login-ssl.rule=HostRegexp(`^login(-ssl)?\\..+`)"
      - "traefik.http.routers.login-ssl.entrypoints=websecure"
      - "traefik.http.routers.login-ssl.tls.certresolver=leresolver"
    environment:
      << : [*env-aspnet]

  metaservices:
    build:
      context: ./
      dockerfile: Zune.Net.MetaServices/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8075:8080"
    labels:
      - "traefik.http.routers.metaservices.rule=HostRegexp(`^metaservices\\..+`)"
      - "traefik.http.routers.metaservices-ssl.rule=HostRegexp(`^metaservices(-ssl)?\\..+`)"
      - "traefik.http.routers.metaservices-ssl.tls.certresolver=leresolver"
      - "traefik.http.routers.metaservices-ssl.entrypoints=websecure"
    environment:
      << : [*env-aspnet]

  mix:
    build:
      context: ./
      dockerfile: Zune.Net.Mix/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8076:8080"
    labels:
      - "traefik.http.routers.mix.rule=HostRegexp(`^mix\\..+`)"
      - "traefik.http.routers.mix-ssl.rule=HostRegexp(`^mix(-ssl)?\\..+`)"
      - "traefik.http.routers.mix-ssl.tls.certresolver=leresolver"
      - "traefik.http.routers.mix-ssl.entrypoints=websecure"
    environment:
      << : [*env-aspnet]

  social:
    build:
      context: ./
      dockerfile: Zune.Net.SocialApi/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8077:8080"
    labels:
      - "traefik.http.routers.socialapi.rule=HostRegexp(`^socialapi\\..+`)"
      - "traefik.http.routers.socialapi-ssl.rule=HostRegexp(`^socialapi(-ssl)?\\..+`)"
      - "traefik.http.routers.socialapi-ssl.tls.certresolver=leresolver"
      - "traefik.http.routers.socialapi-ssl.entrypoints=websecure"
    environment:
      << : [*env-aspnet]

  tiles:
    build:
      context: ./
      dockerfile: Zune.Net.Tiles/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8078:8080"
    labels:
      - "traefik.http.routers.tiles.rule=HostRegexp(`^tiles\\..+`)"
      - "traefik.http.routers.tiles-ssl.rule=HostRegexp(`^tiles(-ssl)?\\..+`)"
      - "traefik.http.routers.tiles-ssl.tls.certresolver=leresolver"
      - "traefik.http.routers.tiles-ssl.entrypoints=websecure"
    environment:
      << : [*env-aspnet]

  tuners:
    build:
      context: ./
      dockerfile: Zune.Net.Tuners/Dockerfile
    depends_on:
      - mongodb
      - traefik
    networks:
      - backend
    ports:
      - "8079:8080"
    labels:
      - "traefik.http.routers.tuners.rule=HostRegexp(`^tuners\\..+`)"
      - "traefik.http.routers.tuners-ssl.rule=HostRegexp(`^tuners(-ssl)?\\..+`)"
      - "traefik.http.routers.tuners-ssl.tls.certresolver=leresolver"
      - "traefik.http.routers.tuners-ssl.entrypoints=websecure"
    environment:
      << : [*env-aspnet]

volumes:
  mongodb_data_container: